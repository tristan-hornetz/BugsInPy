#!/bin/bash
usage="
      -w work_dir
             The working directory to compile the project. Default will be the current directory.
      -f force
             Force the instrumentation, even if the project was already instrumented.
"

force="0"
case $1 in
 -[h?] | --help)
    cat <<-____HALP
        Usage: ${0##*/} [ --help ]
        $usage
____HALP
        exit 0;;
 -f) force="1";;
esac

###Read the flag of checkout
while getopts p:i:v:w: flag
do
    case "${flag}" in
        w) work_dir=${OPTARG};;
    esac
done

framework_location="$( cd "$( dirname "${BASH_SOURCE[0]}" )" >/dev/null 2>&1 && pwd )"

###Update the work directory
if [ "$work_dir" == "" ]; then
   work_dir=$(pwd)
fi

if [[ $work_dir == */ ]]; then
   temp_work_dir="$work_dir"
   work_dir=${temp_work_dir::-1}
fi

###Check work directory
if [[ ! -e "$work_dir/bugsinpy_bug.info" ]]; then
   echo "This is not a checkout project folder"
   exit
elif [[ ! -e "$work_dir/bugsinpy_requirements.txt" ]]; then
   echo "This is not a checkout project folder"
   exit
elif [[ ! -e "$work_dir/bugsinpy_run_test.sh" ]]; then
   echo "This is not a checkout project folder"
   exit
fi

if [[ ! -e "$work_dir/bugsinpy_compile_flag" ]]; then
   echo "You have not compiled this project"
   exit
fi
if [[ -e "$work_dir/bugsinpy_instrument_flag" ]]; then
  if [[ $force != "1" ]]; then
   echo "You have already instrumented this project"
   exit
  else
    echo "Forcing instrumentation..."
  fi
fi

### Create Symlink to Instrumentation source
ln -s "${framework_location}/../py/TestWrapper" "${work_dir}/TestWrapper"

pytest="0"
#read file run_test.sh
DONE=false
until $DONE ;do
read || DONE=true
if [ "$REPLY" != "" ]; then
   if [[ "$REPLY" == *"pytest"* || "$REPLY" == *"py.test"* ]]; then
       pytest="1"
   fi
fi
done < "$work_dir/bugsinpy_run_test.sh"

cd $work_dir

if [[ $pytest == "1" ]]; then
  echo "Pytest detected"
  ### Instrument conftest.py files
  while read -r line
  do
    line_arr=($line)
    if [[ $line == *"/conftest.py" ]]; then
      echo $'\nfrom TestWrapper.WrapperBase import pytest_runtest_call\n' >> "${line_arr[1]}"
      echo "Instrumented ${line_arr[1]}"
    else
      dname=$(dirname "${line_arr[1]}")
      if [ ! -f "$dname/conftest.py" ]; then
        echo $'\nfrom TestWrapper.WrapperBase import pytest_runtest_call\n' >> "$dname/conftest.py"
        echo "Instrumented ${dname}/conftest.py"
      fi
    fi
  done < <(du -a | grep ".*/test_.*py$\|.*_test.py$\|.*/conftest.py$")
else
  echo "Python Unittest detected"
  ### Instrument test files
  while read -r line
  do
    line_arr=($line)
    test_path="${line_arr[1]}"
    wrapper_inport=""
    sed -i '/.*import.* unittest/a\import TestWrapper.WrapperBase as unittest' "${test_path}"
    echo "Instrumented ${test_path}"
  done < <(du -a | grep ".*\.py$")
fi

echo "1" > "$work_dir/bugsinpy_instrument_flag"



